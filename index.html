<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Online Chess</title>

<link rel="stylesheet"
href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css"/>

<style>
body {
    background:#111;
    color:white;
    font-family:Arial;
    display:flex;
    gap:20px;
    padding:20px;
}
#board { width:400px; }
#panel { width:300px; }
#chat { height:150px; overflow:auto; background:#222; padding:5px; }
input, button { width:100%; margin:5px 0; }
</style>
</head>

<body>

<div id="board"></div>

<div id="panel">
    <div id="status"></div>

    <input id="room" placeholder="–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã">
    <button onclick="join()">üåê –í–æ–π—Ç–∏</button>

    <h3>üí¨ –ß–∞—Ç</h3>
    <div id="chat"></div>
    <input id="msg" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ">
    <button onclick="send()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>

    <h3>üé• –ü–æ–≤—Ç–æ—Ä</h3>
    <button onclick="replay()">‚ñ∂Ô∏è</button>

    <h3>üìä –ê–Ω–∞–ª–∏–∑</h3>
    <button onclick="analyze()">Stockfish</button>
</div>

<script src="/socket.io/socket.io.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.13.4/chess.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stockfish/stockfish.js"></script>

<script>
const socket = io();
const game = new Chess();
let board;
let roomId = "";
let replayData = [];

board = Chessboard('board',{
    draggable:true,
    position:'start',
    onDrop:(s,t)=>{
        let m = game.move({from:s,to:t,promotion:'q'});
        if(!m) return 'snapback';
        replayData.push(game.fen());
        socket.emit("move",{room:roomId,fen:game.fen()});
        update();
    }
});

socket.on("move", data=>{
    game.load(data.fen);
    board.position(data.fen);
    replayData.push(data.fen);
    update();
});

socket.on("chat", d=>{
    chat.innerHTML += `<div>${d}</div>`;
});

function join(){
    roomId = room.value;
    socket.emit("join", roomId);
}

function send(){
    socket.emit("chat",{room:roomId,text:msg.value});
    msg.value="";
}

function update(){
    status.textContent = game.in_checkmate() ? "‚ôö –ú–ê–¢" :
        game.in_draw() ? "ü§ù –ù–ò–ß–¨–Ø" :
        (game.turn()==='w'?"–ë–µ–ª—ã–µ":"–ß—ë—Ä–Ω—ã–µ")+" —Ö–æ–¥—è—Ç";
}

function replay(){
    let i=0;
    const t=setInterval(()=>{
        if(i>=replayData.length) return clearInterval(t);
        board.position(replayData[i++]);
    },700);
}

// üìä ANALYSIS
const engine = Stockfish();
engine.postMessage("uci");

function analyze(){
    engine.postMessage("position fen "+game.fen());
    engine.postMessage("go depth 12");
    engine.onmessage=e=>{
        if(e.data.includes("score")){
            alert(e.data);
        }
    }
}
</script>

</body>
</html>









































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































